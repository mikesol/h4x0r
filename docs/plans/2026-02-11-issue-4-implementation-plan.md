# Issue #4: Worker + wrangler.toml — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Emit `gen/worker.js`, `gen/wrangler.toml`, and `gen/manifest.md` during compilation via `onAfterGenerate`.

**Architecture:** Three new emit functions in `Build.hx` called from the existing `onAfterGenerate` callback. All use the existing `serverEndpoints` accumulator. String helpers for name derivation (camelCase → upper_snake, kebab-case).

**Tech Stack:** Haxe 4.3.6 macros, `sys.io.File` for file I/O in `onAfterGenerate`.

**Working directory:** `/home/mikesol/Documents/GitHub/h4x0r/h4x0r-4` (worktree on branch `issue-4`)

---

### Task 1: Add name derivation helpers and emit worker.js

**Files:**
- Modify: `src/h4x0r/Build.hx`

**Step 1: Add name derivation helpers**

Add two static helper functions to Build:

```haxe
static function toUpperSnake(camelCase:String):String {
    var buf = new StringBuf();
    for (i in 0...camelCase.length) {
        var c = camelCase.charAt(i);
        if (c >= "A" && c <= "Z" && i > 0) {
            buf.add("_");
        }
        buf.add(c.toUpperCase());
    }
    return buf.toString();
}

static function toKebab(camelCase:String):String {
    var buf = new StringBuf();
    for (i in 0...camelCase.length) {
        var c = camelCase.charAt(i);
        if (c >= "A" && c <= "Z" && i > 0) {
            buf.add("-");
        }
        buf.add(c.toLowerCase());
    }
    return buf.toString();
}
```

**Step 2: Implement emitWorker()**

```haxe
static function emitWorker():Void {
    if (serverEndpoints.length == 0) return;

    var appClass = serverEndpoints[0].className;
    var doClass = appClass + "DO";
    var binding = toUpperSnake(appClass);

    var buf = new StringBuf();
    buf.add("// gen/worker.js — generated by h4x0r. Do not edit.\n");
    buf.add("import { " + doClass + " } from './do.js';\n\n");
    buf.add("export default {\n");
    buf.add("  async fetch(request, env) {\n");
    buf.add("    const id = env." + binding + ".idFromName(\"default\");\n");
    buf.add("    const stub = env." + binding + ".get(id);\n");
    buf.add("    return stub.fetch(request);\n");
    buf.add("  }\n");
    buf.add("};\n\n");
    buf.add("export { " + doClass + " };\n");

    sys.io.File.saveContent("gen/worker.js", buf.toString());
    trace("[h4x0r] wrote gen/worker.js");
}
```

**Step 3: Register in onAfterGenerate**

In `configure()`, add `emitWorker()` after `emitDOShell()`:

```haxe
Context.onAfterGenerate(function() {
    patchServerExports();
    emitDOShell();
    emitWorker();
});
```

**Step 4: Compile and verify**

Run: `haxe build.hxml 2>&1`

Check that `gen/worker.js` exists and contains:
- `import { TestAppDO } from './do.js'`
- `env.TEST_APP.idFromName("default")`
- `export { TestAppDO }`

**Step 5: Commit**

```bash
git add src/h4x0r/Build.hx
git commit -m "feat(#4): generate gen/worker.js via onAfterGenerate"
```

---

### Task 2: Emit wrangler.toml

**Files:**
- Modify: `src/h4x0r/Build.hx`

**Step 1: Implement emitWranglerToml()**

```haxe
static function emitWranglerToml():Void {
    if (serverEndpoints.length == 0) return;

    var appClass = serverEndpoints[0].className;
    var doClass = appClass + "DO";
    var binding = toUpperSnake(appClass);
    var workerName = toKebab(appClass);

    var buf = new StringBuf();
    buf.add("# gen/wrangler.toml — generated by h4x0r. Do not edit.\n");
    buf.add("name = \"" + workerName + "\"\n");
    buf.add("main = \"worker.js\"\n");
    buf.add("compatibility_date = \"2024-12-01\"\n\n");
    buf.add("[durable_objects]\n");
    buf.add("bindings = [\n");
    buf.add("  { name = \"" + binding + "\", class_name = \"" + doClass + "\" }\n");
    buf.add("]\n\n");
    buf.add("[[migrations]]\n");
    buf.add("tag = \"v1\"\n");
    buf.add("new_classes = [\"" + doClass + "\"]\n");

    sys.io.File.saveContent("gen/wrangler.toml", buf.toString());
    trace("[h4x0r] wrote gen/wrangler.toml");
}
```

**Step 2: Register in onAfterGenerate**

Add `emitWranglerToml()` after `emitWorker()`.

**Step 3: Compile and verify**

Run: `haxe build.hxml 2>&1`

Check that `gen/wrangler.toml` contains:
- `name = "test-app"`
- `main = "worker.js"`
- `name = "TEST_APP"`, `class_name = "TestAppDO"`
- `new_classes = ["TestAppDO"]`

**Step 4: Commit**

```bash
git add src/h4x0r/Build.hx
git commit -m "feat(#4): generate gen/wrangler.toml via onAfterGenerate"
```

---

### Task 3: Emit manifest.md

**Files:**
- Modify: `src/h4x0r/Build.hx`

**Step 1: Implement emitManifest()**

```haxe
static function emitManifest():Void {
    if (serverEndpoints.length == 0) return;

    var appClass = serverEndpoints[0].className;

    var buf = new StringBuf();
    buf.add("# " + appClass + " API\n\n");
    buf.add("Generated by h4x0r. Do not edit.\n\n");
    buf.add("## Endpoints\n\n");
    buf.add("All endpoints use `POST /rpc` with JSON body `{method, args}`.\n\n");

    for (ep in serverEndpoints) {
        var qualName = ep.className + "." + ep.methodName;
        buf.add("### `" + qualName + "`\n");
        buf.add("- **Args:** " + [for (a in ep.args) "`" + a + "`"].join(", ") + "\n\n");
    }

    sys.io.File.saveContent("gen/manifest.md", buf.toString());
    trace("[h4x0r] wrote gen/manifest.md");
}
```

**Step 2: Register in onAfterGenerate**

Add `emitManifest()` after `emitWranglerToml()`.

**Step 3: Compile and verify**

Run: `haxe build.hxml 2>&1`

Check that `gen/manifest.md` contains:
- `# TestApp API`
- Three endpoint sections with correct args

**Step 4: Commit**

```bash
git add src/h4x0r/Build.hx
git commit -m "feat(#4): generate gen/manifest.md via onAfterGenerate"
```

---

### Task 4: End-to-end verification

**Files:**
- No changes — verification only

**Step 1: Verify all acceptance criteria**

1. `gen/worker.js` exists and has correct ES module structure
2. `gen/wrangler.toml` has correct DO bindings and migration
3. `gen/manifest.md` lists all 3 server endpoints
4. All files are valid (visual inspection)

**Step 2: Verify gen/ directory is complete**

After `haxe build.hxml`, `gen/` should contain:
- `client.js` — Haxe-compiled client
- `server.js` — Haxe-compiled server (patched)
- `do.js` — DO shell
- `worker.js` — Worker entry point
- `wrangler.toml` — Deployment config
- `manifest.md` — API docs

**Step 3: Final commit**

```bash
git add -A
git commit -m "feat(#4): generate Worker, wrangler.toml, and manifest.md

Emits gen/worker.js, gen/wrangler.toml, and gen/manifest.md via
onAfterGenerate — completing the Cloudflare deployment artifact pipeline.

- worker.js: stateless ES module forwarding all requests to a single DO
- wrangler.toml: Cloudflare config with DO bindings and migration
- manifest.md: human-readable API endpoint listing

Closes #4"
```

---

## Notes

- **Name derivation is simple**: `toUpperSnake` and `toKebab` handle basic CamelCase → TARGET_CASE conversion. Multi-word names like `PhotoApp` → `PHOTO_APP` / `photo-app` work correctly. Edge cases (acronyms, numbers) are not handled — YAGNI for Phase 1.

- **wrangler dev validation**: The issue asks for `wrangler dev` verification, but that's really issue #5 territory (E2E validation). We verify the generated files are structurally correct here; live deployment testing is #5.
