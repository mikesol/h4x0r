# Issue #4: Generate Worker + wrangler.toml — Design

**Date:** 2026-02-11
**Issue:** https://github.com/mikesol/h4x0r/issues/4
**Status:** Design approved, ready for implementation

## Summary

Emit `gen/worker.js`, `gen/wrangler.toml`, and `gen/manifest.md` via `onAfterGenerate` — completing the Cloudflare deployment artifact pipeline.

## Architecture

### worker.js

Stateless ES module Worker that forwards all requests to a single Durable Object instance. Re-exports the DO class (required by Cloudflare).

```javascript
// gen/worker.js — generated by h4x0r. Do not edit.
import { TestAppDO } from './do.js';

export default {
  async fetch(request, env) {
    const id = env.TEST_APP.idFromName("default");
    const stub = env.TEST_APP.get(id);
    return stub.fetch(request);
  }
};

export { TestAppDO };
```

- **Single DO instance** via `idFromName("default")` — no auth/multi-user in Phase 1.
- **Binding name** derived from class name: `TestApp` → `TEST_APP` (upper-snake-case).
- **Re-exports DO class** — Cloudflare requires DO classes exported from entry point.

### wrangler.toml

```toml
# gen/wrangler.toml — generated by h4x0r. Do not edit.
name = "test-app"
main = "worker.js"
compatibility_date = "2024-12-01"

[durable_objects]
bindings = [
  { name = "TEST_APP", class_name = "TestAppDO" }
]

[[migrations]]
tag = "v1"
new_classes = ["TestAppDO"]
```

- **Worker name**: `TestApp` → `test-app` (kebab-case).
- **Compatibility date**: hardcoded to recent stable date.
- **Migration tag `v1`**: required by Cloudflare to register DO classes on first deploy.

### manifest.md

```markdown
# TestApp API

Generated by h4x0r. Do not edit.

## Endpoints

All endpoints use `POST /rpc` with JSON body `{method, args}`.

### `TestApp.fetchData`
- **Args:** `query`

### `TestApp.sendReport`
- **Args:** `data`

### `TestApp.audit`
- **Args:** `action`
```

Human-readable endpoint listing from the same `serverEndpoints` accumulator.

## Name derivation

| Source | worker.js binding | wrangler.toml name | DO class |
|---|---|---|---|
| `TestApp` | `TEST_APP` | `test-app` | `TestAppDO` |
| `PhotoApp` | `PHOTO_APP` | `photo-app` | `PhotoAppDO` |

Upper-snake-case: insert `_` before each uppercase letter, uppercase all.
Kebab-case: insert `-` before each uppercase letter, lowercase all.

## Files

| File | Change |
|---|---|
| `src/h4x0r/Build.hx` | Add `emitWorker()`, `emitWranglerToml()`, `emitManifest()`, call from `onAfterGenerate` |

## Acceptance criteria (from issue)

- [ ] `gen/worker.js` is emitted during compilation
- [ ] `gen/wrangler.toml` is emitted with correct DO bindings
- [ ] `gen/manifest.md` lists all server endpoints
- [ ] `wrangler dev` can load the generated Worker + DO without errors
- [ ] A curl request to the Worker reaches the DO and returns a response
